# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Codex Update Trino Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Trino version to update to (e.g., 476, 477)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Show inputs
        run: |
          echo "version = ${{ inputs.version }}"

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install packaging lxml

      - name: Configure git user
        run: |
          git config user.name "lance-community"
          git config user.email "community@lance.org"

      - name: Run Codex to update Trino version
        env:
          VERSION: ${{ inputs.version }}
          GITHUB_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
          GH_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.CODEX_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH_NAME="codex/update-trino-${VERSION}"

          cat <<EOF >/tmp/codex-prompt.txt
          You are running inside the lance-trino repository on a GitHub Actions runner. Update the Trino version to ${VERSION} and prepare a pull request for maintainers to review.

          Follow these steps exactly:
          1. Update the Trino version in the root pom.xml. Find the "<version>XXX</version>" element under the root project element (not in dependencies) and update it to "${VERSION}".
          2. The Trino version should also be updated in plugin/trino-lance/pom.xml parent version reference if it exists.
          3. Check the Trino release notes at https://trino.io/docs/current/release/release-${VERSION}.html for any breaking changes or deprecations that might affect the connector.
          4. Run "make lint" to check for any linting issues. If there are issues, run "make format" to fix them and rerun "make lint" until it passes.
          5. Run "make compile" to verify the build works with the new Trino version.
          6. If there are compilation errors due to API changes in Trino, fix them following Trino's migration guides.
          7. Inspect "git status --short" and "git diff" to confirm the version update and any required fixes.
          8. Create and switch to a new branch named "${BRANCH_NAME}".
          9. Stage all relevant files with "git add -A". Commit using the message "chore: update trino version to ${VERSION}".
          10. Push the branch to origin. If the remote branch already exists, delete it first with "gh api -X DELETE repos/lancedb/lance-trino/git/refs/heads/${BRANCH_NAME}" then push with "git push origin ${BRANCH_NAME}". Do NOT use "git push --force" or "git push -f".
          11. env "GH_TOKEN" is available, use "gh" tools for github related operations like creating pull request.
          12. Create a pull request targeting "main" with title "chore: update trino version to ${VERSION}". First, write the PR body to /tmp/pr-body.md using a heredoc (cat <<'EOF' > /tmp/pr-body.md). The body should summarize the Trino version update, any API changes handled, and build verification. Then run "gh pr create --body-file /tmp/pr-body.md".
          13. Display the PR URL, "git status --short", and a concise summary of the commands run and their results.

          Constraints:
          - Use bash commands; avoid modifying GitHub workflow files other than through the scripted task above.
          - Do not merge the PR.
          - If any command fails, diagnose and fix the issue instead of aborting.
          - For Trino API compatibility issues, reference ~/oss/trino for the latest Trino connector APIs.
          EOF

          printenv OPENAI_API_KEY | codex login --with-api-key
          codex --config shell_environment_policy.ignore_default_excludes=true exec --dangerously-bypass-approvals-and-sandbox "$(cat /tmp/codex-prompt.txt)"
